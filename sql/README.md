# SQL Bootstrap

This directory contains **lane templates**, **global rollups**, and **views** for the Fabric demo.

## Layout

```
sql/
  Makefile                     # workflow targets (lanes, shared tables/views, bootstrap)
  README.md                    # this file
  lanes/                       # rendered per-lane SQL (generated by make lane)
  templates/                   # reusable templates (envsubst-based)
    fabric_lane_template.sql
  shared/
    shared_tables.sql           # global rollups (create FIRST)
    shared_views.sql            # shared views (create LAST)
```

## Apply order

1. **Shared tables** (`make shared.tables`) → global rollup tables must exist first  
2. **Lanes** (`make lanes`) → apply all existing lane SQL under `sql/lanes/`  
3. **Shared views** (`make shared.views`) → define cross-source dashboards/ML views  

## Everyday workflow

Most of the time you just run:

```bash
cd sql
make bootstrap   # up → shared.tables → lanes → shared.views
```

This brings up services, ensures shared tables, applies all lanes already in `sql/lanes/`, and sets up the shared views.

## On-demand workflow (add a new lane)

Occasionally, you may want to add a new source stream. That’s when you use:

```bash
cd sql
make lane SOURCE=jira STREAM=events ORG=adage DOMAIN=demo VERSION=1
```

This will render `sql/lanes/jira_events.sql` from the template and apply it to ClickHouse.  
From then on, it’s part of `make lanes` / `make bootstrap`.

## Adding lanes to `parsed_all`

Update `shared/shared_views.sql` with a UNION of parsed tables:

```sql
CREATE OR REPLACE VIEW parsed_all AS
SELECT * FROM parsed_mongodb_cdc
UNION ALL
SELECT * FROM parsed_jira_events;
```

## Fixtures to Kafka

```bash
# produce fixtures into Redpanda
make feed FILE=../fixtures/case_orders_happy.jsonl TOPIC=adage.demo.mongodb.cdc.v1
```

## Troubleshooting

- Run `make shared.tables` before any lanes to avoid MV errors  
- If Grafana panels are empty, check with:  
  ```sql
  SELECT count() FROM fact_events_minute_all WHERE t_min >= now()-INTERVAL 1 HOUR;
  ```
