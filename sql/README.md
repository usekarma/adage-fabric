# SQL Bootstrap

This directory contains the **lane templates**, **global rollups**, and **views** for Fabric.

## Layout

```
sql/
  Makefile                     # schema-only workflows (shared tables, lanes, views, bootstrap)
  README.md                    # this file
  lanes/                       # rendered per-lane SQL (generated by make lane)
  templates/                   # reusable templates (envsubst-based)
    fabric_lane_template.sql
  shared/
    shared_tables.sql           # global rollups (apply first)
    shared_views.sql            # shared views (apply last)
```

## Apply order

1. **Shared tables** (`make shared.tables`) → global rollup tables must exist first  
2. **Lanes** (`make lanes`) → apply all rendered lane SQL under `sql/lanes/`  
3. **Shared views** (`make shared.views`) → define cross-source dashboards/ML views  

## Everyday workflow

Most of the time you just run:

```bash
cd sql
make bootstrap   # shared.tables → lanes → shared.views
```

This assumes the containers are already running (start them from the repo root with `make up`).  
The SQL bootstrap ensures shared tables, applies all lanes in `sql/lanes/`, and sets up the shared views.

## On-demand workflow (add a new lane)

Occasionally, you may want to add a new source stream. That’s when you use:

```bash
cd sql
make lane SOURCE=jira STREAM=events ORG=adage DOMAIN=demo VERSION=1
```

This will render `sql/lanes/jira_events.sql` from the template and apply it to ClickHouse.  
From then on, it’s included in `make lanes` / `make bootstrap`.

## Adding lanes to `parsed_all`

Update `shared/shared_views.sql` with a UNION of parsed tables:

```sql
CREATE OR REPLACE VIEW parsed_all AS
SELECT * FROM parsed_mongodb_cdc
UNION ALL
SELECT * FROM parsed_jira_events;
```

## Fixtures to Kafka

```bash
# produce fixtures into Redpanda
make feed FILE=../fixtures/case_orders_happy.jsonl TOPIC=adage.demo.mongodb.cdc.v1
```

## Querying

From inside `sql/`, you can run quick queries with the ClickHouse client:

```bash
docker exec -it $(docker ps --format '{{.Names}}' | grep clickhouse | head -n1) clickhouse-client
```

Common checks:

```sql
SHOW TABLES;
DESCRIBE TABLE parsed_mongodb_cdc;
SELECT count() FROM fact_events_minute_all WHERE t_min >= now() - INTERVAL 1 HOUR;
```

Or open the web UI at [http://localhost:8123/play](http://localhost:8123/play).

## Troubleshooting

- Run `make shared.tables` before any lanes to avoid materialized view errors.  
- If Grafana panels are empty, check whether facts are being populated with:  
  ```sql
  SELECT count() FROM fact_events_minute_all WHERE t_min >= now() - INTERVAL 1 HOUR;
  ```
- Drop/re-render a lane if schema changed:  
  ```bash
  rm sql/lanes/mongodb_cdc.sql
  make lane SOURCE=mongodb STREAM=cdc ORG=adage DOMAIN=demo VERSION=1
  ```
